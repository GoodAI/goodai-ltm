
### Evaluations of embedding models

We're interested in retrieval of relatively short 
passages (one to a few sentences) using conversational
queries that may be found in a chat. To this end we've developed
an evaluation based on datasets [QReCC](https://github.com/apple/ml-qrecc),
[StrategyQA](https://allenai.org/data/strategyqa), and
[MS MARCO](https://microsoft.github.io/msmarco/). (Fine-tuning is
done with different datasets.)
Results in the following table show top-3 and top-10
retrieval accuracy for each dataset.

Model | qrecc @3 | qrecc @10 | strategyqa @3 | strategyqa @10 | msmarco @3 | msmarco @10
----- |-------| -------- |-----------|------------| --------- | ----------
openai:text-embedding-ada-002 | 67.09 | 76.80 | 68.00     | 82.40      | 73.10 | 80.14 | 
st:sentence-transformers/multi-qa-MiniLM-L6-cos-v1 | 69.98 | 77.57 | 73.90     | 87.75      | 70.31 | 77.71 |
st:sentence-transformers/all-distilroberta-v1 | 65.01 | 76.15 | 66.35     | 82.50      | 68.59 | 78.34 |
st:sentence-transformers/sentence-t5-large | 68.40 | 78.28 | 72.55     | 86.60      | 71.30 | 80.51 |
st:sentence-transformers/all-mpnet-base-v2 | 70.69 | 80.19 | 74.50     | 87.65      | 75.00 | 81.77 |
st:sentence-transformers/multi-qa-mpnet-base-cos-v1 | 74.95 | 82.42 | 79.75     | 91.25      | 75.00 | 82.85 |
**em-MiniLM-p1-01** (ours) | 72.43 | 79.26 | 75.50 | 89.00 | 71.75 | 79.60 |
**em-MiniLM-p3-01** (ours) | 72.87 | 80.02 | 78.00     | 89.75      | 73.38 | 79.96 |
**em-distilroberta-p1-01** (ours) | 77.67 | 83.84 | 83.25     | 94.15      | **79.78** | 84.39 |
**em-distilroberta-p3-01** (ours) | 78.33 | **84.66** | 86.55     | 95.40      | 79.51 | **85.29** |
**em-distilroberta-p5-01** (ours) | **78.88** | 84.44 | **87.40** | **95.70**  | 79.24 | 84.84 |

Model `em-distilroberta-p1-01` is the default embedding model used
by this library. While `em-distilroberta-p3-01` and `em-distilroberta-p5-01` have better
retrieval accuracy, note that they require storing 3 and 5 embeddings
per chunk, respectively. 

## Retrieval dataset examples

The following are 10 queries sampled from the dataset constructed out of StrategyQA, along with the expected
passage, and the 3 top matching passages retrieved using 2 different embedding models. There is a high margin
of error when selecting a sample of size 10, but we picked one that is representative of the overall results.

<table border=1 width="100%">
<tr><th width="25%">Query</th><th width="25%">Expected Passage</th><th width="25%">em-distilroberta-p5-01</th><th width="25%">openai:text-embedding-ada-002</th></tr>
<tr><td valign=top>Stephen: British mathematician and computer scientist<br>Rachel: Did Alan Turing suffer the same fate as Abraham Lincoln?<br>Stephen:</td><td valign=top>Alan Turing committed suicide via cyanide poisoning.</td><td valign=top>1) <b>Scholars have determined Noah&#x27;s Ark to be 75 feet wide.<br>Alan Turing committed suicide via cyanide poisoning.<br>Jeff Goldnlum starred in the 1986 movie The Fly.</b><br>2) Keelhauling was a severe punishment whereby the condemned man was dragged beneath the shipâ€™s keel on a rope.<br>Nikola Tesla was born in the Austrian Empire<br>Lips and skin turn blue in response to a lack of oxygen.<br>3) The main character of &quot;Alice&#x27;s Adventures in Wonderland&quot; is Alice, a young girl.<br>Arnold Schwarzenegger deadlifted 710 pounds in a competition.<br></td><td valign=top>1) James Watson is a geneticist, who believes in his own work.<br>The Greek alphabet is still commonly used<br>Rick and Morty is available in blu-ray format.<br>2) <b>Scholars have determined Noah&#x27;s Ark to be 75 feet wide.<br>Alan Turing committed suicide via cyanide poisoning.<br>Jeff Goldnlum starred in the 1986 movie The Fly.</b><br>3) Weather phenomena refers to types of weather caused conditions such as cyclones, storms, and tsunamis.<br>Elton John was knighted by the Queen of England.<br>Alice&#x27;s Adventures in Wonderland was published in 1865<br>Subway hired Jared Fogle as a spokesman for their sandwich shops.<br></td></tr>
<tr><td valign=top> power<br>Rachel: Is greed the most prevalent of the Seven Deadly Sins?<br>Stephen:</td><td valign=top>Greed is a longing for wealth and power.</td><td valign=top>1) Bing is a search engine, which is a digital object.<br>The seven deadly sins are:  pride, greed, wrath, envy, lust, gluttony, and sloth.<br>2) Adherents to Catholicism subscribe to the notion of the &#x27;7 deadly sins&#x27;.<br>Pea pods on average have 5 to 6 peas inside.<br>Family Guy and American Dad are both Fox Animated Sitcoms animated by Seth MacFarlane.<br>3) <b>Greed is a longing for wealth and power.<br>Lieutenant the second junior-most or in some cases the junior-most commissioned officer in the armed forces, fire services, police, and other organizations of many nations.</b><br></td><td valign=top>1) <b>Greed is a longing for wealth and power.<br>Lieutenant the second junior-most or in some cases the junior-most commissioned officer in the armed forces, fire services, police, and other organizations of many nations.</b><br>2) Bing is a search engine, which is a digital object.<br>The seven deadly sins are:  pride, greed, wrath, envy, lust, gluttony, and sloth.<br>3) Water polo is a sport played by teams of seven competitors<br>The biblical Sarah lived to the age of 127.<br>Glenn Beck is a right wing commentator known for strong opinions and serious tone.<br></td></tr>
<tr><td valign=top><br>Rachel: Would it be difficult for Kami Rita to climb Mount Emei?<br>Stephen:</td><td valign=top>Kami Rita has climbed Mount Everest 24 times.</td><td valign=top>1) <b>The MLB World Series is held annually in a stadium belonging to one of its teams<br>Kami Rita has climbed Mount Everest 24 times.<br>Electronics company Casio was founded in 1946.</b><br>2) The Golden Gate Bridge is one of the most popular suicide spots in the USA.<br>Mount Emei is a 70 ton mountain located in China.<br>3) Tenzing Norgay was a mountaineer that climbed Mount Everest in 1953.<br>J.K Rowling&#x27;s top sellers are her Harry Potter series.<br>Goblin sharks are carnivores that subsist on other fish, cephalopods and crustaceans<br>A<br></td><td valign=top>1) Mount Emei is a 70 ton mountain located in China.<br>A central tenet of the Catholic Church is a one-to-one match between man and woman.<br>2) <b>The MLB World Series is held annually in a stadium belonging to one of its teams<br>Kami Rita has climbed Mount Everest 24 times.<br>Electronics company Casio was founded in 1946.</b><br>3) Tenzing Norgay was a mountaineer that climbed Mount Everest in 1953.<br>J.K Rowling&#x27;s top sellers are her Harry Potter series.<br>Goblin sharks are carnivores that subsist on other fish, cephalopods and crustaceans<br>A<br></td></tr>
<tr><td valign=top> armed forces<br>Rachel: Would Gomer Pyle salute a lieutenant?<br>Stephen:</td><td valign=top>Gomer Pyle was a character on a television sitcom</td><td valign=top>1) <b>The Empire Award for Best Newcomer was awarded for an actor in their debut role.<br>Many people do not notice depression in their friends or loved ones. <br>Gomer Pyle was a character on a television sitcom<br>China accounts for 4.</b><br>2) Lieutenant the second junior-most or in some cases the junior-most commissioned officer in the armed forces, fire services, police, and other organizations of many nations.<br>3) is a 13 member kpop group<br>Nicole Kidman supports the Nashville Predators and has been photographed almost nightly throughout the season.<br>A soldier is a member of the armed forces.<br>The Yale University student body consists of 12,385 people according to a 2015 poll.<br></td><td valign=top>1) Jane Austen was the second youngest of 8 children.<br>The Confederate States Army was clad in cadet gray uniforms.<br>2) Cast iron skillets can scratch or crack flat top stoves.<br>In 1965 the president announced an intention to increase the amount of troops to 125,000<br>Glutamic acid is an amino acid and neurotransmitter<br>The Holy Land is sacred to Judaism, Islam and Christianity<br>The lunar surface<br>3) <b>Many people do not notice depression in their friends or loved ones. <br>Gomer Pyle was a character on a television sitcom<br>China accounts for 4.6 trillion or 12.</b><br></td></tr>
<tr><td valign=top> of stereoisomers<br>Rachel: Is it bad to have lactic acid in your body?<br>Stephen:</td><td valign=top>The body naturally produces and uses lactic acid to convert glucose into energy</td><td valign=top>1) <b>Coffee can only be grown in subtropical and equatorial climates<br>The body naturally produces and uses lactic acid to convert glucose into energy<br>Solvent refers to the assets of a project being greater than the liabilities.</b><br>2) The Mona Lisa is in the Louvre.<br>Tricarboxylic acid as an acid that manifests itself in fruits as citric acid.<br>3) The rings are made mostly of dust and particles.<br>Myocardial infarction is a problem in the heart.<br>Chlorine prevents algae from growing in pools<br>Grand master is the highest title a chess player can get.<br></td><td valign=top>1) Tricarboxylic acid as an acid that manifests itself in fruits as citric acid.<br>The S in C-SPAN refers to Satellite.<br>2) <b>Coffee can only be grown in subtropical and equatorial climates<br>The body naturally produces and uses lactic acid to convert glucose into energy<br>Solvent refers to the assets of a project being greater than the liabilities.</b><br>3) Bodybuilders want to build muscle and keep fat low<br>When milk becomes acidic, the water and fats separate from each other.<br>The next presidential elections will take place in November of 2020<br>Apartheid lasted from 1948 until the early 1990s.<br></td></tr>
<tr><td valign=top>Stephen: form of alternative medicine<br>Rachel: Are some chiropractic manipulations dangerous?<br>Stephen:</td><td valign=top>Manipulations of the neck can lead to complications such as stroke or paralysis.</td><td valign=top>1) <b>The Order of the British Empire is awarded to people that have made significant contributions to the United Kingdom<br>The American Flag is colored red, white, and blue.<br>Manipulations of the neck can lead to complications such as stroke or paralysis.</b><br>2) Dementia refers to various disorders of the brain.<br>Surgery is used to correct medical problems or make physical alterations to the body<br>Conan the Barbarian is a comic book character.<br>3) Macaques grow up to 28 inches in length<br>The fairy tale character Snow White was friends with seven dwarfs.<br>Acupuncture doesn&#x27;t usually feel painful for most people.<br>Lee Sedol is a former South Korean professional Go player of 9 dan rank.<br></td><td valign=top>1) Nikola Tesla built a facility called the Wardenclyffe Tower in Shoreham, New York<br>Doctors of Homeopathy are practitioners of &quot;alternative medicine&quot; <br>Lord Voldemort is a powerful wizard from the Harry Potter Series.<br>2) Walt Disney died in 1966<br>Snakebites are dangerous because they inject venom into blood streams.<br>Pacifists are a group opposed to violence and war.<br>&quot;Marco Polo&quot; is a popular game among children and adults played while swimming.<br>3) Macaques grow up to 28 inches in length<br>The fairy tale character Snow White was friends with seven dwarfs.<br>Acupuncture doesn&#x27;t usually feel painful for most people.<br>Lee Sedol is a former South Korean professional Go player of 9 dan rank.<br></td></tr>
<tr><td valign=top> Britishâ€“American film director, screenwriter, and producer<br>Rachel: Could Christopher Nolan&#x27;s movies finance Cyprus&#x27;s entire GDP?<br>Stephen:</td><td valign=top>The films of Christopher Nolan have grossed around 4.7 billion at the box office.</td><td valign=top>1) <b>The Easter Bunny is a symbol of the Christian holiday of Easter<br>The films of Christopher Nolan have grossed around 4.7 billion at the box office.<br>The Constitution of the Philippines is a document ratified in 1987<br>MP3 is a file compression format for audio recordings<br>Friday the 13th is known as</b><br>2) variety of Mexican and Tex-Mex foods that include tacos, burritos, quesadillas, and nachos.<br>Iceland had a nominal GDP of $27 billion as of a 2018 estimate.<br>As of 2020, The Rush Limbaugh Show has been on the airwaves since 1988.<br>3) The Coen brothers direct films primarily using English<br>The B-52 bomber plane cost 60 million dollars in 2018.<br>David Lynch is a director that created the television show Twin Peaks.<br></td><td valign=top>1) <b>The Easter Bunny is a symbol of the Christian holiday of Easter<br>The films of Christopher Nolan have grossed around 4.7 billion at the box office.<br>The Constitution of the Philippines is a document ratified in 1987<br>MP3 is a file compression format for audio recordings<br>Friday the 13th is known as</b><br>2) the right to vote in presidential elections.<br>Microsoft Excel is a computer program<br>Adam Sandler is Jewish.<br>Christopher Nolan rose to fame in large part because of his trilogy of Batman movies released from 2005 to 2012<br>Green is a color made by mixing blue<br>3) The Coen brothers direct films primarily using English<br>The B-52 bomber plane cost 60 million dollars in 2018.<br>David Lynch is a director that created the television show Twin Peaks.<br></td></tr>
<tr><td valign=top>Stephen: American actor, comedian, screenwriter, and producer<br>Rachel: Would the average American family find Adam Sandler&#x27;s home to be too small?<br>Stephen:</td><td valign=top>The average American family has about 3 people in it.</td><td valign=top>1) <b>Immersion Baptism is the practice of submerging people underwater for a religious ritual.<br>The average American family has about 3 people in it.<br>The Social Democratic Party of Germany was founded in 1863.</b><br>2) the right to vote in presidential elections.<br>Microsoft Excel is a computer program<br>Adam Sandler is Jewish.<br>Christopher Nolan rose to fame in large part because of his trilogy of Batman movies released from 2005 to 2012<br>Green is a color made by mixing blue<br>3) Silicon is a key material for the production of semiconductor chips.<br>Adam Sandler and Cole Sprouse starred together in &quot;Big Daddy&quot;.<br>Lil Wayne has four children.<br></td><td valign=top>1) Adherents to Catholicism subscribe to the notion of the &#x27;7 deadly sins&#x27;.<br>Pea pods on average have 5 to 6 peas inside.<br>Family Guy and American Dad are both Fox Animated Sitcoms animated by Seth MacFarlane.<br>2) the right to vote in presidential elections.<br>Microsoft Excel is a computer program<br>Adam Sandler is Jewish.<br>Christopher Nolan rose to fame in large part because of his trilogy of Batman movies released from 2005 to 2012<br>Green is a color made by mixing blue<br>3) Saddam Hussein died on December 30th, 2006.<br>Steve Martin is allergic to shellfish.<br>Mickey Mouse is a Disney character that has starred in numerous movies and TV specials.<br></td></tr>
<tr><td valign=top>Stephen: Medical condition where poor blood flow to the brain causes cell death<br>Rachel: Did Dale Jr.&#x27;s father crash his car due to a stroke?<br>Stephen:</td><td valign=top>Dale Earnhardt Jr. is his late father&#x27;s namesake.</td><td valign=top>1) <b>The Fibonaacci number is a sequence of numbers that adds a number to the one before it and goes on forever.<br>Dale Earnhardt Jr. is his late father&#x27;s namesake.</b><br>2) A caracal is a small wild cat<br>Dale Jr. and his father Dale Sr. last raced together at the Daytona 500 in 2001.<br>3) Cerebral palsy is a disease that results from damage to a young person&#x27;s brain.<br>The bottom of the gulf is one of the world&#x27;s largest ship cemeteries.<br></td><td valign=top>1) in 1908<br>Multiple Sclerosis is a progressive condition affecting the brain and spinal chord.<br>Saddam Hussein died on December 30th, 2006.<br>2) Parsifal was loosely based on a poem about Percival<br>Hypothermia typically occurs from exposure to extreme cold.<br>Traffic collisions sometimes result in extremely expensive physical damage.<br>Goofy is an anthropomorphic dog character.<br>3) Cerebral palsy is a disorder caused by damage to fetal or infant brains.<br>Bitcoin was launched as a currency in 2009.<br></td></tr>
<tr><td valign=top>Stephen: Academic tertiary education, such as from colleges and universities<br>Rachel: Did Emma Stone pursue a higher education?<br>Stephen:</td><td valign=top>Higher education, also called post-secondary education, third-level or tertiary education, is an optional final stage of formal learning that occurs after completion of secondary education.</td><td valign=top>1) <b>Shivambu is another term for &#x27;Urine Therapy&#x27;, an alternative belief about healing with urine.<br>Higher education, also called post-secondary education, third-level or tertiary education, is an optional final stage of formal learning that occurs after completion of secondary education.</b><br>2) Superbad features two main characters that are nerds on a quest for love, and ends with them being victorious.<br>Johns Hopkins University had an endowment of $6.<br>3) The qualifications to be a tax collector in the US inlude a bachelor&#x27;s degree in accounting.<br>Naomi Watts starred in King Kong (2005 film).<br>Gay men can have any of the various sex organs that humans have.<br></td><td valign=top>1) <b>Higher education, also called post-secondary education, third-level or tertiary education, is an optional final stage of formal learning that occurs after completion of secondary education.</b><br>2) Alfa Romeo makes cars.<br>Some of the things geologists study include gemstones, minerals, and stone<br>The Toronto Star has a classifieds section<br>QWERTY keyboards are an alphabet key layout that were first used on typrwriters<br>3) College degrees require at least 2 years of study to obtain.<br>LeBron James is 6 feet 9 inches tall.<br></td></tr>
</table>

### Boosting the accuracy of low-resource embedding models

At this time, we haven't found a reranking cross-encoder that can consistently boost
the retrieval accuracy of our best embedding models. That said, you can use accurate
embedding models as query-passage matching models, alongside a low-resource embedding
model. *This combination's accuracy nearly matches that of the best embedding models from 
this library.*

The following tests were performed by configuring a memory to use `em-MiniLM-p1-01`
as the embedding model and `em:em-distilroberta-p5-01` as the matching/reranking model
with different values of the `reranking_k_factor` setting.

reranking_k_factor | qrecc @3 | qrecc @10 | strategyqa @3 | strategyqa @10 | msmarco @3 | msmarco @10
----- |----------|-----------|---------------|----------------|------------| ----------
1 | 76.97    | 79.75     | 84.65         | 89.05          | 76.62      | 79.33 |
2 | 77.95    | 81.39     | 86.55         | 92.85          | 77.89      | 81.41 |
3 | 78.33    | 82.53     | 87.10         | 93.90          | 78.61      | 82.85 |
5 | 78.60    | 83.19     | 87.35         | 94.60          | 78.97      | 83.48 |
8  | 78.93    | 84.44     | 87.25         | 95.15          | 79.33      | 83.84 |
10 | 78.93    | 84.50     | 87.45         | 95.55          | 79.15      | 84.21 |

Model `em-MiniLM-p1-01` stores a single embedding of size 384 per chunk, while model
`em-distilroberta-p5-01` produces 5 storage embeddings per chunk, of size 768. The number of storage embeddings
has little impact when the embedding model is used as a query-passage matching model.
It does matter, however, in terms of chunk storage capacity when embeddings
are attached to chunks. In the case of the two models in question, the difference 
in footprint is 10-fold.

Using a matching model does come with a performance overhead in every query, but in 
the context of an LLM-based chat agent implementation, the overhead should be unnoticeable.

